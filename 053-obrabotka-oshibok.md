### 53\. Обработка ошибок

Ошибки в Node.js обрабатываются с помощью исключений. 

##### Создание исключения

Исключение создается с помощью ключевого слова throw. 
`
throw value
`

При достижении данной строки кода выполнение программы останавливается и управление передается ближайшему обработчику исключений. 

Как правило, в клиентском коде value может быть любым допустимым типом данных, таким как строка, число или объект. 

В Node.js мы выбрасываем только объекты ошибки. 

##### Объект ошибки

Объект ошибки - это объект, который является либо экземпляром объекта Error, либо наследником класса Error, предоставляемого [модулем Error][anchor0]. 
`
throw new Error('Ran out of coffee')
`

Или 
`
class NotEnoughCoffeeError extends Error {
    // ...
}
throw new NotEnoughCoffeeError()
`

##### Обработка исключений

Исключение обрабатывается в блоке try/catch. 
Любое исключение, возникшее в try, обрабатывается ближайшим catch. 
`
try {
    // ... 
} catch (e) {}
`

e - это значение исключения. 

Вы можете добавить несколько обработчиков для обработки разных ошибок. 

##### Обработка непойманных (неперехваченных) исключений

Если в процессе выполнения программы возникнет неперехваченное исключение, выполнение программы остановится. 

Для решения данной проблемы необходимо добавить обработчик события uncaughtException объекта process: 
`
process.on('uncaughtException', err => {
    console.error('There was an uncaught error', err)
    process.exit(1) // вызов данного метода является обязательным
})
`

Получать модуль process не требуется, поскольку он внедрен по умолчанию. 

##### Исключения и промисы

С помощью промисов можно выполнить разные операции и обработать ошибки в самом конце: 
`
doSomething1()
    .then(doSomething2)
    .then(doSomething3)
    .catch(err => console.error(err))
`

Как узнать, где возникла ошибка? Для этого можно обрабатывать ошибки в каждой функции, которая вызывается (doSomethingX), и внутри обработчика ошибок выбрасывать новую ошибку, которая будет перехвачена внешним catch: 
`
const doSomething1 = () => {
    //...
    try {
        //...
    } catch (err) {
        //... обрабатываем ошибку локального
        throw new Error(err.message)
    }
    //...
}
`

Для локальной обработки ошибок без их обработки внутри вызываемой функции, можно разорвать цепочку и создать в каждом then() специальную функцию:
`
doSomething1()
.then(() => {
    return doSomething2().catch(err => {
    // обрабатываем ошибку
    throw err // разрываем цепочку!
    })
})
.then(() => {
    return doSomething2().catch(err => {
    // обрабатываем ошибку
    throw err // разрываем цепочку!
    })
})
.catch(err => console.error(err))
`

##### Обработка ошибок с помощью async/await

При использовании async/await вам также нужно обрабатывать ошибки: 
`
async function someFunction() {
    try {
        await someOtherFunction()
    } catch (err) {
        console.error(err.message)
    }
}
`

[anchor0]: https://nodejs.org/api/errors.html

